# React createContext 错误诊断指南

## 问题描述
错误信息：`Uncaught TypeError: Cannot read properties of undefined (reading 'createContext')`
错误位置：`Context.js:2` 或 `StyleContext.js:47`

## 问题原因
`@ant-design/cssinjs` 的 `StyleContext.js` 文件在第 47 行模块级别调用了 `React.createContext`：
```javascript
var StyleContext = /*#__PURE__*/React.createContext({...})
```

这意味着当这个模块被加载和执行时，`React` 必须已经可用。如果 React chunk 还没有执行完成，`React` 就是 `undefined`。

## 如何查看问题

### 1. 检查浏览器控制台
- 打开浏览器开发者工具（F12）
- 查看 Console 标签
- 找到错误信息，点击错误链接查看具体位置

### 2. 检查网络加载顺序
- 打开 Network 标签
- 刷新页面
- 查看 JS 文件的加载顺序
- **重要**：`vendor-react-*.js` 应该在其他 vendor chunk 之前加载

### 3. 检查构建后的 HTML
文件位置：`frontend/dist/index.html`
- 查看 `<script>` 和 `<link rel="modulepreload">` 的顺序
- `vendor-react` 的 modulepreload 应该在 `vendor-antd` 之前

### 4. 检查源代码
文件位置：`frontend/node_modules/@ant-design/cssinjs/es/StyleContext.js`
- 第 6 行：`import * as React from 'react';`
- 第 47 行：`var StyleContext = React.createContext({...})`

### 5. 检查 Vite 配置
文件位置：`frontend/vite.config.ts`
- 确认 `@ant-design/cssinjs` 在 `vendor-react` chunk 中
- 确认 `rc-util` 也在 `vendor-react` chunk 中
- 确认 `react-is` 也在 `vendor-react` chunk 中

## 解决方案

### 已实施的修复
1. ✅ 将 `@ant-design/cssinjs` 放入 `vendor-react` chunk
2. ✅ 将 `@ant-design/cssinjs-utils` 放入 `vendor-react` chunk
3. ✅ 将 `rc-util` 放入 `vendor-react` chunk
4. ✅ 将 `react-is` 放入 `vendor-react` chunk
5. ✅ 在 `main.tsx` 中添加 React 加载检查

### 如果问题仍然存在

#### 方案 1：检查浏览器缓存
1. 按 `Ctrl + Shift + Delete` 清除缓存
2. 或者按 `Ctrl + F5` 强制刷新
3. 或者在开发者工具中右键刷新按钮 → "清空缓存并硬性重新加载"

#### 方案 2：检查模块加载顺序
在浏览器控制台运行：
```javascript
// 检查 React 是否已加载
console.log('React:', typeof React !== 'undefined' ? React : '未加载')
console.log('React.createContext:', typeof React !== 'undefined' ? typeof React.createContext : 'React 未加载')
```

#### 方案 3：检查构建产物
```bash
cd frontend
npm run build
# 检查 dist/index.html 中的 script 顺序
# 检查 dist/assets/vendor-react-*.js 文件大小（应该包含 cssinjs）
```

#### 方案 4：临时解决方案（不推荐）
如果问题持续，可以考虑将所有 Ant Design 相关代码也放入 React chunk：
```typescript
// vite.config.ts
if (id.includes('antd') || id.includes('@ant-design')) {
  return 'vendor-react'  // 临时：全部放入 React chunk
}
```

## 验证修复
1. 清除浏览器缓存
2. 刷新页面
3. 检查控制台是否还有错误
4. 检查页面是否正常加载

