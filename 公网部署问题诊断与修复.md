# 🔍 公网部署问题诊断与修复指南

## 📋 问题概述

**症状：** 网站可以在本地电脑打开，但无法公网部署

**根本原因：** 前后端分离项目需要分别部署，且需要正确配置环境变量和API地址

---

## 🔍 问题诊断步骤

### 步骤1：检查前端部署状态

1. **确认前端是否已部署**
   - 如果使用Vercel：访问 https://vercel.com/dashboard
   - 检查项目是否存在
   - 检查最新部署状态是否为 "Ready"（绿色）

2. **检查前端地址**
   - 访问您的前端地址（如：`https://xxx.vercel.app`）
   - 如果页面能打开但功能异常 → 继续步骤2
   - 如果页面无法打开 → 检查部署配置

### 步骤2：检查环境变量配置

**这是最常见的问题！**

#### 2.1 检查Vercel环境变量

1. **进入Vercel项目设置**
   - 访问：https://vercel.com/dashboard
   - 选择您的前端项目
   - 点击 "Settings" → "Environment Variables"

2. **检查必需的环境变量**
   ```
   VITE_API_URL=https://您的后端地址/api
   ```
   
   **重要：**
   - 变量名必须是 `VITE_API_URL`（注意VITE前缀）
   - 值必须是完整的后端API地址，以 `/api` 结尾
   - 必须选择所有环境（Production, Preview, Development）

3. **如果环境变量不存在或错误**
   - 点击 "Add New"
   - 添加正确的环境变量
   - **保存后必须重新部署！**

#### 2.2 重新部署前端（环境变量更改后必须执行）

1. **在Vercel中重新部署**
   - 进入 "Deployments" 标签
   - 找到最新部署
   - 点击右侧 "..." → "Redeploy"
   - 或等待自动重新部署（可能需要几分钟）

2. **验证环境变量是否生效**
   - 部署完成后，访问前端网站
   - 按 `F12` 打开开发者工具
   - 查看 Console 标签
   - 应该看到：`🌐 当前API基础URL: https://您的后端地址/api`
   - 如果显示 `localhost` 或错误的地址 → 环境变量未生效

### 步骤3：检查后端部署状态

1. **确认后端是否已部署**
   - 如果使用Railway：访问 https://railway.app/dashboard
   - 检查服务状态是否为 "Running"（绿色）

2. **获取后端地址**
   - 在Railway项目 → "Settings" → "Networking"
   - 确认有公共域名（如：`https://xxx.up.railway.app`）
   - 如果没有，点击 "Generate Domain"

3. **测试后端API**
   - 在浏览器中直接访问：`https://您的后端地址/api/stats`
   - 应该返回JSON数据
   - 如果返回404或错误 → 后端配置有问题

### 步骤4：检查CORS配置

1. **检查后端CORS设置**
   - 后端代码中已配置CORS
   - 确认 `FRONTEND_URL` 环境变量已设置
   - 值应该是：`https://您的前端地址.vercel.app`

2. **如果CORS错误**
   - 在浏览器Console中会看到：
     ```
     Access to fetch at 'xxx' from origin 'xxx' has been blocked by CORS policy
     ```
   - 解决方法：在后端添加正确的前端地址到CORS允许列表

---

## ✅ 完整修复流程

### 方案A：使用Vercel + Railway（推荐）

#### 1. 部署后端（Railway）

1. **访问Railway**
   - https://railway.app
   - 使用GitHub登录

2. **创建新项目**
   - 点击 "New Project"
   - 选择 "Deploy from GitHub repo"
   - 选择您的仓库

3. **配置环境变量**
   - 在项目 → "Variables" 标签
   - 添加以下变量：
     ```env
     NODE_ENV=production
     PORT=3001
     NEO4J_URI=neo4j+s://您的Neo4j地址
     NEO4J_USER=neo4j
     NEO4J_PASSWORD=您的Neo4j密码
     FRONTEND_URL=https://您的前端地址.vercel.app
     CORS_ORIGIN=https://您的前端地址.vercel.app
     ```

4. **获取后端地址**
   - 部署完成后，在 "Networking" 获取公共URL
   - 类似：`https://xxx.up.railway.app`
   - **复制这个地址**

#### 2. 部署前端（Vercel）

1. **访问Vercel**
   - https://vercel.com
   - 使用GitHub登录

2. **创建新项目**
   - 点击 "New Project"
   - 选择您的GitHub仓库
   - 配置：
     - **Framework Preset**: Vite
     - **Root Directory**: frontend
     - **Build Command**: `npm run build`
     - **Output Directory**: dist

3. **添加环境变量（关键步骤！）**
   - 在项目 → "Settings" → "Environment Variables"
   - 添加：
     ```
     Name: VITE_API_URL
     Value: https://您的Railway后端地址/api
     ```
   - 选择所有环境（Production, Preview, Development）
   - 点击 "Save"

4. **部署**
   - Vercel会自动部署
   - 等待部署完成（约2-3分钟）

5. **获取前端地址**
   - 部署完成后获得：`https://xxx.vercel.app`

#### 3. 更新后端CORS配置

1. **回到Railway**
   - 更新 `FRONTEND_URL` 环境变量
   - 设置为您的Vercel前端地址
   - Railway会自动重新部署

#### 4. 测试

1. **访问前端地址**
   - 打开浏览器开发者工具（F12）
   - 查看Console标签
   - 应该看到：`🌐 当前API基础URL: https://您的后端地址/api`

2. **测试功能**
   - 尝试搜索功能
   - 查看知识图谱
   - 检查Network标签中的API请求状态

---

## 🐛 常见错误及解决方案

### 错误1：前端显示空白页面

**原因：** 构建失败或资源路径错误

**解决：**
1. 检查Vercel部署日志
2. 确认 `vite.config.ts` 中的 `base` 配置正确
3. 确认 `vercel.json` 配置正确

### 错误2：API请求返回404

**原因：** 环境变量未设置或未生效

**解决：**
1. 确认 `VITE_API_URL` 环境变量已添加
2. 确认值格式正确（以 `/api` 结尾）
3. **重新部署前端**（环境变量更改后必须重新部署）

### 错误3：CORS错误

**原因：** 后端未允许前端域名

**解决：**
1. 在后端添加 `FRONTEND_URL` 环境变量
2. 确认后端CORS配置包含前端地址
3. 重新部署后端

### 错误4：后端连接失败

**原因：** 后端服务未运行或地址错误

**解决：**
1. 检查Railway服务状态
2. 确认后端地址正确
3. 测试后端健康检查：`https://后端地址/health`

### 错误5：环境变量显示为undefined

**原因：** Vite环境变量必须以 `VITE_` 开头

**解决：**
1. 确认变量名是 `VITE_API_URL`（不是 `API_URL`）
2. 重新部署前端

---

## 📝 检查清单

部署前请确认：

- [ ] 后端已部署并运行正常
- [ ] 后端地址已获取（如：`https://xxx.up.railway.app`）
- [ ] 前端已部署到Vercel
- [ ] Vercel环境变量 `VITE_API_URL` 已设置
- [ ] 环境变量值格式正确（以 `/api` 结尾）
- [ ] 环境变量更改后已重新部署前端
- [ ] 后端 `FRONTEND_URL` 环境变量已设置
- [ ] 浏览器Console显示正确的API地址
- [ ] 后端健康检查接口可访问

---

## 🔧 快速修复脚本

如果问题仍然存在，可以尝试：

1. **清除浏览器缓存**
   - 按 `Ctrl+Shift+Delete`
   - 清除缓存和Cookie

2. **检查网络连接**
   - 确认可以访问后端地址
   - 测试：`curl https://您的后端地址/health`

3. **查看详细日志**
   - Vercel部署日志：项目 → Deployments → 点击部署 → View Logs
   - Railway部署日志：项目 → Deployments → 查看日志

---

## 💡 提示

1. **环境变量更改后必须重新部署才能生效**
2. **Vite环境变量必须以 `VITE_` 开头**
3. **生产环境不会使用 `vite.config.ts` 中的proxy配置**
4. **前后端必须分别部署，不能只部署前端**

---

## 📞 需要帮助？

如果按照以上步骤仍无法解决，请提供：
1. 前端部署地址
2. 后端部署地址
3. 浏览器Console错误信息
4. Network标签中的请求详情

