# 连接问题解决方案

## 🔴 当前问题

错误：`ERR_CONNECTION_CLOSED` - 无法连接到 Render 后端服务

## ✅ 已完成的优化

### 1. 自动重试机制
- ✅ 所有API请求都添加了自动重试功能
- ✅ 网络错误时自动重试2次
- ✅ 服务器错误（5xx）时自动重试
- ✅ 重试间隔递增（2秒 → 3秒 → 4.5秒）

### 2. 超时保护
- ✅ 所有请求设置30秒超时
- ✅ 超时后自动取消请求

### 3. 友好的错误提示
- ✅ 连接错误时显示："无法连接到服务器。Render服务可能正在休眠，请稍候再试。首次访问需要30-60秒唤醒服务。"
- ✅ 超时错误时显示："请求超时。服务器响应时间过长，请稍候再试。"

## 🔧 解决方案

### 方案1：等待Render服务唤醒（推荐）

Render免费服务会在15分钟无活动后休眠，首次访问需要30-60秒唤醒。

**操作步骤：**
1. 刷新页面
2. 等待30-60秒
3. 系统会自动重试连接
4. 如果仍然失败，再次刷新

### 方案2：手动唤醒Render服务

1. 在浏览器中直接访问：
   ```
   https://tcm-knowledge-graph.onrender.com/health
   ```
2. 等待返回 `{"status":"ok"}`
3. 然后刷新应用页面

### 方案3：检查Render服务状态

1. 登录 [Render Dashboard](https://dashboard.render.com/)
2. 找到服务：`tcm-knowledge-graph`
3. 检查服务状态：
   - ✅ **Live** - 服务正常运行
   - ⚠️ **Sleeping** - 服务休眠中（需要唤醒）
   - ❌ **Stopped** - 服务已停止（需要启动）

### 方案4：升级到付费计划（长期方案）

Render免费计划的服务会休眠，付费计划可以保持服务始终运行。

## 📊 错误类型说明

### ERR_CONNECTION_CLOSED
- **原因**：Render服务休眠或网络连接中断
- **解决**：等待服务唤醒或刷新页面

### Failed to fetch
- **原因**：网络请求失败
- **解决**：检查网络连接，系统会自动重试

### Timeout
- **原因**：服务器响应时间超过30秒
- **解决**：等待服务唤醒后重试

## 🎯 最佳实践

1. **首次访问**：耐心等待30-60秒，让Render服务唤醒
2. **频繁使用**：如果经常使用，考虑升级到付费计划
3. **错误处理**：系统已自动处理重试，无需手动操作
4. **监控服务**：定期检查Render Dashboard确保服务正常运行

## 📝 技术细节

### 重试机制
```typescript
- 重试次数：2次
- 初始延迟：2秒
- 延迟递增：1.5倍
- 总等待时间：最多约9秒（2秒 + 3秒 + 4.5秒）
```

### 超时设置
```typescript
- 请求超时：30秒
- 适用于所有API请求
```

### 错误处理
```typescript
- 自动识别连接错误
- 提供友好的中文错误提示
- 区分不同类型的错误
```

## ⚠️ 注意事项

1. **不要频繁刷新**：等待自动重试完成
2. **检查网络**：确保网络连接正常
3. **查看控制台**：查看详细的错误信息
4. **联系支持**：如果问题持续，检查Render服务状态

## 🚀 下一步

1. ✅ 提交代码到GitHub
2. ✅ 等待Vercel自动部署
3. ✅ 测试重试机制是否正常工作
4. ✅ 如果问题持续，考虑升级Render服务

完成以上步骤后，连接问题应该会得到改善。系统现在会自动处理重试，用户只需要等待即可。

